<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>スマホ対応シューティング</title>
<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  text-align: center;
  font-family: sans-serif;
  touch-action: none;
}
canvas {
  background: #111;
  display: block;
  margin: 0 auto;
}
#ui {
  display: flex;
  justify-content: space-between;
  padding: 10px;
}
#shotBtn {
  width: 120px;
  height: 60px;
  font-size: 20px;
}
</style>
</head>
<body>

<h3>シューティングゲーム</h3>
<canvas id="game" width="400" height="600"></canvas>

<div id="ui">
  <div></div>
  <button id="shotBtn">SHOT</button>
</div>

<p id="status"></p>
<button id="restartBtn" style="display:none;">リスタート</button>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");
const restartBtn = document.getElementById("restartBtn");
const shotBtn = document.getElementById("shotBtn");

let score, lives, level, playerLevel;
let bullets, enemies, lasers;
let enemyTimer, gameOver;
let invincible, invincibleTimer, blinkTimer;
let laserTimer, warning, warningTimer, warningX;
let boss = null;
const BOSS_HP = 30;

let player;
let moveLeft = false;
let moveRight = false;

function init() {
  score = 0;
  lives = 3;
  level = 1;
  playerLevel = 1;

  bullets = [];
  enemies = [];
  lasers = [];

  enemyTimer = 0;
  gameOver = false;

  invincible = false;
  invincibleTimer = 0;
  blinkTimer = 0;

  laserTimer = 0;
  warning = false;
  warningTimer = 0;

  boss = null;

  player = { x: 180, y: 520, w: 40, h: 40, speed: 5 };

  updateStatus();
  restartBtn.style.display = "none";
}

function updateStatus() {
  statusText.textContent =
    `Score:${score} 残機:${lives} LEVEL:${level} PLAYER LV:${playerLevel}`;
}

/* ===== 入力（PC） ===== */
const keys = {};
document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

/* ===== 入力（スマホ） ===== */
canvas.addEventListener("touchstart", e => {
  const x = e.touches[0].clientX;
  if (x < window.innerWidth / 2) moveLeft = true;
  else moveRight = true;
});

canvas.addEventListener("touchend", () => {
  moveLeft = false;
  moveRight = false;
});

shotBtn.addEventListener("touchstart", shoot);
shotBtn.addEventListener("mousedown", shoot);

function shoot() {
  if (bullets.length >= 8) return;
  if (playerLevel >= 2) {
    bullets.push({x: player.x+8, y: player.y});
    bullets.push({x: player.x+28, y: player.y});
  } else {
    bullets.push({x: player.x+18, y: player.y});
  }
}

/* ===== ゲーム更新 ===== */
function update() {
  if (gameOver) return;

  if (invincible) {
    invincibleTimer--;
    blinkTimer++;
    if (invincibleTimer <= 0) invincible = false;
  }

  if ((keys.ArrowLeft || moveLeft) && player.x > 0) player.x -= player.speed;
  if ((keys.ArrowRight || moveRight) && player.x < canvas.width - player.w)
    player.x += player.speed;

  if (keys.Space) {
    shoot();
    keys.Space = false;
  }

  bullets.forEach(b => b.y -= 7);
  bullets = bullets.filter(b => b.y > 0);

  if (!boss) {
    enemyTimer++;
    if (enemyTimer > Math.max(15, 40 - level * 3)) {
      enemies.push({
        x: Math.random() * 370,
        y: -25,
        w: 25, h: 25,
        speed: 2 + level * 0.5
      });
      enemyTimer = 0;
    }
  }

  enemies.forEach(e => e.y += e.speed);

  if (!boss && score > 0 && score % 50 === 0) {
    boss = { x: 100, y: 60, w: 200, h: 60, hp: BOSS_HP };
    enemies = [];
  }

  bullets.forEach((b, bi) => {
    enemies.forEach((e, ei) => {
      if (hit(b,4,10,e)) {
        bullets.splice(bi,1);
        enemies.splice(ei,1);
        score++;
        if (score % 15 === 0) { level++; playerLevel++; }
      }
    });
    if (boss && hit(b,4,10,boss)) {
      bullets.splice(bi,1);
      boss.hp--;
      if (boss.hp <= 0) {
        boss = null;
        score++;
      }
    }
  });

  if (!invincible) {
    enemies.forEach((e,ei)=>{
      if(hit(player,player.w,player.h,e)){
        enemies.splice(ei,1);
        damage();
      }
    });
  }

  updateStatus();
}

function hit(a,aw,ah,b){
  return a.x < b.x+b.w && a.x+aw > b.x &&
         a.y < b.y+b.h && a.y+ah > b.y;
}

function damage(){
  lives--;
  invincible = true;
  invincibleTimer = 80;
  if(lives<=0){
    gameOver=true;
    restartBtn.style.display="inline-block";
  }
}

function draw(){
  ctx.clearRect(0,0,400,600);

  if(!invincible || blinkTimer%10<5){
    ctx.fillStyle="cyan";
    ctx.fillRect(player.x,player.y,player.w,player.h);
  }

  ctx.fillStyle="yellow";
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,4,10));

  ctx.fillStyle="red";
  enemies.forEach(e=>ctx.fillRect(e.x,e.y,e.w,e.h));

  if(boss){
    ctx.fillStyle="purple";
    ctx.fillRect(boss.x,boss.y,boss.w,boss.h);
  }

  if(gameOver){
    ctx.fillStyle="white";
    ctx.font="30px sans-serif";
    ctx.fillText("GAME OVER",100,300);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

restartBtn.onclick = init;
init();
loop();
</script>
</body>
</html>
